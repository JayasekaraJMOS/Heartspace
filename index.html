<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>üå∏ HeartSpace üå∏</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<style>
  :root {
    --primary-pink: #ff8fa3;
    --accent-red: #ff4d6d;
    --glass: rgba(255, 255, 255, 0.92);
    --default-bg: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
    --angry-bg: linear-gradient(135deg, #ff4d4d 0%, #f9ca24 100%);
  }

  body {
    margin: 0; padding: 0;
    font-family: 'Quicksand', sans-serif;
    background: var(--default-bg);
    background-attachment: fixed;
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
    min-height: 100vh;
    overflow-x: hidden;
    transition: background 0.8s ease;
    -webkit-tap-highlight-color: transparent;
  }

  body.angry-mode { background: var(--angry-bg) !important; }

  #appContent { display: none; padding-bottom: 100px; }
  
  /* MOBILE NAVIGATION */
  .nav-menu {
    position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
    background: var(--glass); backdrop-filter: blur(15px);
    display: flex; gap: 20px; padding: 12px 25px; border-radius: 50px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 2000;
    width: fit-content; border: 1px solid rgba(255,255,255,0.3);
  }
  .nav-item { cursor: pointer; font-size: 1.8rem; transition: 0.2s; padding: 5px; border-radius: 50%; }
  .nav-item.active { transform: scale(1.2); color: var(--accent-red); }

  .view { display: none; width: 100%; max-width: 450px; margin: 10px auto; padding: 0 20px; box-sizing: border-box; }
  .view.active { display: block; animation: fadeIn 0.3s ease-out; }

  header { text-align: center; padding: 25px 10px; }
  .profile-pic { width: 90px; height: 90px; border-radius: 50%; border: 3px solid white; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
  
  .card { background: var(--glass); padding: 20px; border-radius: 30px; margin-bottom: 15px; backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

  /* MOBILE PROGRESS */
  .progress-wrapper { position: relative; width: 130px; height: 130px; margin: 0 auto 10px; display: flex; justify-content: center; align-items: center; }
  .progress-circle-svg { width: 130px; height: 130px; transform: rotate(-90deg); }
  .circle-bg { fill: none; stroke: rgba(0,0,0,0.05); stroke-width: 10; }
  .circle-bar { fill: none; stroke: var(--accent-red); stroke-width: 10; stroke-linecap: round; transition: stroke-dashoffset 0.8s ease; }

  /* MOBILE GOAL ITEMS */
  .item { 
    background: white; padding: 18px; border-radius: 25px; 
    margin-bottom: 15px; border-left: 10px solid var(--primary-pink); 
    position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.04);
  }

  .goal-text { font-size: 1.2rem; font-weight: 600; color: #333; display: block; margin-bottom: 5px; line-height: 1.3; }

  .deadline-badge {
    font-size: 0.9rem; font-weight: bold; color: white;
    background: var(--primary-pink); padding: 5px 12px;
    border-radius: 10px; display: inline-block; margin-top: 5px;
  }
  .expired-badge { background: #ff4d4d; animation: pulse-critical 1.5s infinite; }

  .item-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; border-top: 1px solid #f5f5f5; padding-top: 12px; }

  /* LARGER TOUCH TARGETS */
  button { 
    border: none; padding: 12px 20px; border-radius: 18px; 
    font-weight: 600; cursor: pointer; transition: 0.2s; 
    font-family: inherit; font-size: 1rem;
  }
  .btn-done { background: var(--accent-red); color: white; min-width: 80px; }
  .btn-remove { background: #f0f0f0; color: #888; font-size: 0.9rem; }

  input, textarea { 
    width: 100%; padding: 15px; margin: 10px 0; border-radius: 18px; 
    border: 1px solid #eee; box-sizing: border-box; outline: none; 
    font-size: 16px; /* Prevents iOS zoom on focus */
  }

  @keyframes pulse-critical { 0% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 77, 77, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 77, 77, 0); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div id="heartBgContainer"></div>

<div id="authScreen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:inherit; display:flex; justify-content:center; align-items:center; z-index:3000; padding: 20px; box-sizing: border-box;">
  <div class="card" style="width:100%; max-width: 320px; text-align:center;">
    <h1 style="font-family:'Dancing Script'; color:var(--accent-red); font-size: 2.5rem; margin-bottom: 10px;">HeartSpace</h1>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="handleLogin()" style="width:100%; background:var(--accent-red); color:white; margin-top: 10px;">Login üíñ</button>
    <button onclick="handleSignup()" style="background:none; color:#999; font-size:0.9rem; margin-top:15px; width: 100%;">New here? Create Profile</button>
  </div>
</div>

<div id="appContent">
  <nav class="nav-menu">
    <div class="nav-item active" onclick="switchView('journal', this)">üìù</div>
    <div class="nav-item" onclick="switchView('goals', this)">üéØ</div>
    <div class="nav-item" onclick="switchView('profile', this)">‚öôÔ∏è</div>
    <div class="nav-item" onclick="logout()">üö™</div>
  </nav>

  <header>
    <img id="displayPic" class="profile-pic" src="https://via.placeholder.com/100">
    <h1 id="userTitle" style="font-family:'Dancing Script'; margin: 10px 0 0;">My Space</h1>
  </header>

  <div id="journalView" class="view active">
    <div class="card">
      <h2 style="margin-bottom: 5px;">Daily Note</h2>
      <textarea id="entryInput" placeholder="Write a memory..." rows="3"></textarea>
      <button onclick="addEntry()" style="width:100%; background:var(--accent-red); color:white;">Save to Memories</button>
    </div>
    <input type="text" id="searchInput" placeholder="üîç Search dates..." onkeyup="renderEntries()">
    <div id="entriesList"></div>
  </div>

  <div id="goalsView" class="view">
    <div class="card" style="text-align: center;">
      <div class="progress-wrapper">
        <svg class="progress-circle-svg"><circle class="circle-bg" cx="65" cy="65" r="55"></circle><circle id="progressBar" class="circle-bar" cx="65" cy="65" r="55"></circle></svg>
        <div style="position:absolute; text-align:center;">
            <span id="moodFace" style="font-size:2.5rem;">üòç</span><br>
            <span id="taskRatio" style="font-weight:bold; color:var(--accent-red); font-size: 1.1rem;">0/0</span>
        </div>
      </div>
      <h2 style="margin: 5px 0 0;">Progress</h2>
    </div>
    <div class="card">
      <h2>New Goal</h2>
      <input type="text" id="goalInput" placeholder="Enter goal...">
      <input type="date" id="goalDate">
      <button onclick="addGoal()" style="width:100%; background:var(--accent-red); color:white;">Add Goal</button>
    </div>
    <div id="goalsList"></div>
  </div>

  <div id="profileView" class="view">
    <div class="card">
      <h2>Settings</h2>
      <div style="margin-bottom: 20px;">
        <label style="font-weight: 600; display: block; margin-bottom: 5px;">Profile Picture</label>
        <input type="file" id="upDp" accept="image/*">
        <button onclick="clearSetting('dp')" style="background:#ff7675; color:white; font-size:0.8rem; width:100%; margin-top:5px; padding: 8px;">Remove Pic</button>
      </div>
      <div style="margin-bottom: 10px;">
        <label style="font-weight: 600; display: block; margin-bottom: 5px;">Background Image</label>
        <input type="file" id="upBg" accept="image/*">
        <button onclick="clearSetting('bg')" style="background:#ff7675; color:white; font-size:0.8rem; width:100%; margin-top:5px; padding: 8px;">Remove BG</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentUser = null;
const dbKey = 'heartspace_mobile_v15';

const getDb = () => JSON.parse(localStorage.getItem(dbKey)) || {};
const saveDb = (db) => localStorage.setItem(dbKey, JSON.stringify(db));

// AUTH
function handleSignup() {
    const u = document.getElementById('username').value.trim(), p = document.getElementById('password').value.trim();
    if(!u || !p) return alert("Fill all fields");
    let db = getDb(); if(db[u]) return alert("Username taken");
    db[u] = { password: p, dp: '', bg: '', entries: [], goals: [] };
    saveDb(db); alert("Profile created! Please login.");
}

function handleLogin() {
    const u = document.getElementById('username').value.trim(), p = document.getElementById('password').value.trim();
    let db = getDb();
    if(db[u] && db[u].password === p) { currentUser = u; startApp(); }
    else alert("Invalid login");
}

function startApp() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('appContent').style.display = 'block';
    refreshUI();
}

function refreshUI() {
    const data = getDb()[currentUser];
    document.getElementById('userTitle').innerText = `${currentUser}'s Space`;
    document.getElementById('displayPic').src = data.dp || 'https://via.placeholder.com/100';
    document.body.style.backgroundImage = data.bg ? `url(${data.bg})` : '';
    renderEntries(); renderGoals();
}

function clearSetting(type) {
    let db = getDb(); db[currentUser][type] = '';
    saveDb(db); refreshUI();
}

function logout() { location.reload(); }

function switchView(id, el) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.getElementById(id + 'View').classList.add('active');
    el.classList.add('active');
    window.scrollTo(0,0);
}

// IMAGE CROP
async function processImage(file, isSquare) {
    return new Promise((resolve) => {
        const reader = new FileReader(); reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                let targetW = 1000, targetH = isSquare ? 1000 : 1500;
                canvas.width = targetW; canvas.height = targetH;
                let sX = 0, sY = 0, sW = img.width, sH = img.height;
                const aspect = targetW / targetH;
                if ((img.width / img.height) > aspect) { sW = img.height * aspect; sX = (img.width - sW) / 2; }
                else { sH = img.width / aspect; sY = (img.height - sH) / 2; }
                ctx.drawImage(img, sX, sY, sW, sH, 0, 0, targetW, targetH);
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            }
        }
    });
}

document.getElementById('upDp').onchange = async (e) => {
    const res = await processImage(e.target.files[0], true);
    let db = getDb(); db[currentUser].dp = res; saveDb(db); refreshUI();
};
document.getElementById('upBg').onchange = async (e) => {
    const res = await processImage(e.target.files[0], false);
    let db = getDb(); db[currentUser].bg = res; saveDb(db); refreshUI();
};

// DATA HANDLING
function addEntry() {
    const val = document.getElementById('entryInput').value.trim();
    if(!val) return;
    let db = getDb(); db[currentUser].entries.unshift({ id: Date.now(), text: val, date: new Date().toLocaleDateString() });
    saveDb(db); document.getElementById('entryInput').value = ''; renderEntries();
}

function renderEntries() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    const entries = getDb()[currentUser].entries;
    document.getElementById('entriesList').innerHTML = entries.filter(e => e.date.includes(q)).map(e => `
        <div class="item">
            <small style="color:#aaa">${e.date}</small>
            <div style="font-family:'Dancing Script'; font-size:1.7rem; margin:8px 0; color: #444;">${e.text}</div>
            <button onclick="delEntry(${e.id})" style="background:none; color:#ff7675; padding:0; font-size: 0.85rem;">Remove Memory</button>
        </div>
    `).join('');
}
function delEntry(id) { if(confirm("Delete this memory?")) { let db = getDb(); db[currentUser].entries = db[currentUser].entries.filter(e => e.id !== id); saveDb(db); renderEntries(); } }

function addGoal() {
    const t = document.getElementById('goalInput').value.trim(), d = document.getElementById('goalDate').value;
    if(!t || !d) return;
    let db = getDb(); db[currentUser].goals.unshift({ id: Date.now(), text: t, date: d, done: false });
    saveDb(db); document.getElementById('goalInput').value = ''; renderGoals();
}

function toggleGoal(id) {
    let db = getDb();
    db[currentUser].goals = db[currentUser].goals.map(g => {
        if(g.id === id) { if(!g.done) confetti(); return {...g, done: !g.done}; } return g;
    });
    saveDb(db); renderGoals();
}

function delGoal(id) { if(confirm("Remove goal?")) { let db = getDb(); db[currentUser].goals = db[currentUser].goals.filter(g => g.id !== id); saveDb(db); renderGoals(); } }

function renderGoals() {
    const goals = getDb()[currentUser].goals;
    const todayStr = new Date().toISOString().split('T')[0];
    const done = goals.filter(g => g.done).length, tot = goals.length;
    document.getElementById('taskRatio').innerText = `${done}/${tot}`;
    document.getElementById('moodFace').innerText = tot === 0 ? 'üòç' : ['üò≠', 'üò¢', 'üòê', 'üôÇ', 'üòä', 'üòç'][Math.floor((done/(tot||1))*5)];
    const c = 2 * Math.PI * 55;
    document.getElementById('progressBar').style.strokeDasharray = c;
    document.getElementById('progressBar').style.strokeDashoffset = tot === 0 ? 0 : c - (done/tot)*c;

    const sorted = [...goals].sort((a, b) => {
        const aEx = !a.done && a.date < todayStr; const bEx = !b.done && b.date < todayStr;
        if (a.done !== b.done) return a.done ? 1 : -1;
        if (aEx !== bEx) return aEx ? -1 : 1;
        return new Date(a.date) - new Date(b.date);
    });

    let isAngry = false;
    document.getElementById('goalsList').innerHTML = sorted.map(g => {
        const ex = !g.done && g.date < todayStr; if(ex) isAngry = true;
        const diff = Math.ceil((new Date(g.date) - new Date(todayStr)) / 86400000);
        let badge = g.done ? "Done! üåü" : (diff < 0 ? `Expired ${Math.abs(diff)}d ago` : (diff==0 ? "Due Today! ‚ö°" : `${diff} days left`));
        return `
        <div class="item" style="${g.done ? 'opacity:0.6; border-color:#ccc' : (ex ? 'border-color:red; border-left-width:12px' : '')}">
            <span class="goal-text" style="${g.done ? 'text-decoration:line-through; color: #888':''}">${g.text}</span>
            <small style="color:#999;">Due: ${g.date}</small><br>
            <div class="deadline-badge ${!g.done && diff<=0 ? 'expired-badge':''}">${badge}</div>
            <div class="item-actions">
                <button class="btn-remove" onclick="delGoal(${g.id})">Remove</button>
                <button class="btn-done" onclick="toggleGoal(${g.id})" style="background:${g.done ? '#aaa' : ''}">${g.done ? 'Undo' : 'Done'}</button>
            </div>
        </div>`;
    }).join('');
    document.body.className = isAngry ? 'angry-mode' : '';
}

// Background Flowers
setInterval(() => {
    const p = document.createElement('div');
    p.innerHTML = 'üå∏';
    p.style.cssText = `position:fixed; left:${Math.random()*100}vw; top:110vh; font-size:${Math.random()*20+15}px; z-index:-1; transition:6s linear; pointer-events:none;`;
    document.getElementById('heartBgContainer').appendChild(p);
    setTimeout(() => p.style.transform = `translateY(-120vh) rotate(${Math.random()*360}deg)`, 100);
    setTimeout(() => p.remove(), 6000);
}, 2500);
</script>
</body>
</html>
